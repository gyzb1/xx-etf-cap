# 512890红利低波ETF复制策略回测系统

> **当前版本**: v1.3.0-unified  
> **更新日期**: 2024-12-09  
> **数据源**: Tushare Pro API

基于 Tushare Pro API 的智能投资组合回测系统，复制512890红利低波ETF持仓并使用双因子模型优化权重。

## 🚀 快速开始

### 访问统一回测页面
```
http://localhost:3001/backtest.html
```

**一个页面，两种回测方式**：
- 📊 **静态回测**：使用最新持仓回测历史表现
- 🔄 **动态回测**：跟随ETF实际披露节奏调仓

## 🎯 核心功能

### 📊 静态回测
- **最新持仓回测**：使用最新披露的完整持仓（中报/年报）
- **历史表现评估**：评估当前持仓策略的历史有效性
- **适用场景**：快速验证策略、评估持仓质量

### 🔄 动态回测
- **跟随ETF持仓变化**：自动识别所有历史报告期（中报/年报）
- **自动调仓**：每次持仓披露时自动调整组合
- **连续净值曲线**：从指定日期开始生成完整净值序列
- **详细周期分析**：展示每个持仓期的权重分布和持仓变化
- **适用场景**：模拟真实投资、评估实际收益

👉 [查看动态调仓详细文档](./DYNAMIC_REBALANCING.md)

### ✨ 共同特点

- ✅ **自动获取ETF持仓**：实时获取512890 ETF的持仓股票
- ✅ **双因子加权模型**：股息率（Dividend Yield）+ ROCE（资本回报率）
- ✅ **智能数据处理**：自动处理缺失数据，使用合理填充策略
- ✅ **对比分析**：与512890 ETF基准进行收益对比
- ✅ **可视化净值曲线**：归一化净值曲线，直观展示相对表现
- ✅ **详细信息展示**：股票名称、权重、因子数据等
- ✅ **现代化Web界面**：响应式设计，支持移动端

## 策略说明

### 核心思想

本系统复制512890红利低波ETF的持仓股票，但不采用ETF的原始权重，而是使用**双因子模型**重新计算权重，以期获得更优的风险收益比。

### 双因子模型详解

#### 1. 股息率（Dividend Yield）

**定义**：股息率反映股票的分红回报率，是价值投资的重要指标。

**计算方法**：
```
股息率 = (每股股息 / 股价) × 100%
```

**数据来源**：
- 优先使用 `dv_ratio`（股息率）
- 如果缺失，使用 `dv_ttm`（TTM股息率）
- 如果仍然为0，使用最小值0.01%避免完全排除

**意义**：
- 高股息率股票通常具有稳定的现金流
- 适合追求稳定收益的投资者
- 红利低波策略的核心指标之一

#### 2. ROCE（Return on Capital Employed，资本回报率）

**定义**：ROCE衡量公司使用资本创造利润的效率，反映企业的盈利能力。

**计算公式**：
```
ROCE = EBIT / (总资产 - 流动负债) × 100%

其中：
- EBIT = 息税前利润（Earnings Before Interest and Tax）
- 总资产 = 公司资产负债表中的总资产
- 流动负债 = 公司资产负债表中的流动负债
- 资本使用 = 总资产 - 流动负债
```

**数据来源**：
- **利润指标**：从利润表（`income`）获取
  - 优先使用 `ebit`（息税前利润）
  - 对于银行等金融企业，如果EBIT为null，使用 `operate_profit`（营业利润）或 `total_profit`（利润总额）
- **资产负债**：从资产负债表（`balancesheet`）获取
  - `total_assets`（资产总计）
  - `total_cur_liab`（流动负债合计）- 普通企业
  - `total_hldr_eqy_exc_min_int`（股东权益合计）- 金融企业
- **报告期**：自动获取最新的财报数据，不限定具体报告期

**特殊处理 - 金融企业**：
- 银行、保险等金融企业的资产负债表结构与普通企业不同
- 金融企业没有"流动负债"概念（`total_cur_liab` 为 null）
- 对于金融企业，使用**股东权益**作为资本使用：
  ```
  普通企业：资本使用 = 总资产 - 流动负债
  金融企业：资本使用 = 股东权益
  ```
- 这样确保银行股也能正确计算ROCE

**意义**：
- 高ROCE表示公司能高效利用资本创造利润
- 反映企业的核心竞争力和管理效率
- 与股息率结合，筛选出既有分红能力又有盈利能力的优质股票

#### 3. 权重计算方法

**步骤1：筛选有效股票**
- 只使用同时具备股息率和ROCE数据的股票
- ROCE缺失的股票权重为0，不参与组合
- 对于股息率为0的股票，在计算时赋予最小值0.01%

**步骤2：因子归一化**
```
归一化股息率 = (股息率 - 最小股息率) / (最大股息率 - 最小股息率)
归一化ROCE = (ROCE - 最小ROCE) / (最大ROCE - 最小ROCE)
```

**步骤3：综合评分**
```
综合评分 = (归一化股息率 + 归一化ROCE) / 2
```
两个因子等权重，各占50%

**步骤4：权重分配**
```
股票权重 = 该股票综合评分 / 所有股票综合评分之和
```

**结果**：
- 所有权重之和 = 100%
- 股息率高且ROCE高的股票获得更高权重
- 即使某个因子缺失，股票仍然参与权重分配

### 净值计算

#### 组合净值
```
初始净值 = 1.0
每日净值 = Σ(每只股票权重 × 该股票当日涨跌幅) + 1.0
```

#### ETF基准净值
```
初始净值 = 1.0
每日净值 = ETF当日净值 / ETF初始净值
```

两条曲线都归一化到1.0起点，便于直观对比相对表现。

## 技术栈

- **后端**: Node.js + Express
- **前端**: HTML5 + Chart.js
- **数据源**: Tushare Pro API

## 快速开始

### 1. 安装依赖

```bash
npm install
```

### 2. 配置 Tushare Token

创建 `.env` 文件并添加您的 Tushare token：

```bash
TUSHARE_TOKEN=your_tushare_token_here
PORT=3001
```

### 3. 启动服务器

```bash
npm start
```

或使用开发模式（自动重启）：

```bash
npm run dev
```

### 4. 访问应用

打开浏览器访问：
- **动态调仓回测**（推荐）：http://localhost:3001/dynamic.html
- **静态回测**：http://localhost:3001

## 使用说明

### 选择日期范围

- **开始日期**：建议选择年初或季度初
- **结束日期**：默认为当前日期

### 查看结果

点击"开始回测"后，系统会：
1. 自动获取512890 ETF的最新持仓股票（约84只）
2. 获取所有股票的历史价格数据
3. 获取财务数据并计算股息率和ROCE
4. 使用双因子模型计算每只股票的权重
5. 计算组合的净值曲线
6. 获取512890 ETF的净值曲线作为基准
7. 展示对比图表、统计数据和详细的股票信息表

## API 接口

### POST /api/backtest-dynamic (推荐)

**动态调仓回测接口** - 跟随512890持仓变化并使用双因子模型优化权重

这是推荐使用的接口，能够真实模拟ETF持仓变化带来的调仓过程。

**核心特点**：
- 自动识别所有历史报告期（中报/年报）
- 每次持仓披露时自动调仓
- 每个持仓期使用双因子模型重新计算权重
- 生成连续的净值曲线

**请求体：**
```json
{
  "startDate": "20240101",
  "endDate": "20241207"
}
```

**响应：**
```json
{
  "success": true,
  "data": {
    "portfolio": [
      {"date": "20240102", "netValue": 1.0030},
      {"date": "20240103", "netValue": 1.0125}
    ],
    "etf": [
      {"date": "20240102", "netValue": 1.0020},
      {"date": "20240103", "netValue": 1.0110}
    ],
    "periods": [
      {
        "reportDate": "20231231",
        "startDate": "20240101",
        "endDate": "20240630",
        "stockCount": 140,
        "topHoldings": [
          {"code": "600295.SH", "weight": "1.46"}
        ]
      },
      {
        "reportDate": "20240630",
        "startDate": "20240630",
        "endDate": "20241207",
        "stockCount": 82,
        "topHoldings": [
          {"code": "600188.SH", "weight": "2.18"}
        ]
      }
    ],
    "statistics": {
      "portfolioReturn": "9.48",
      "etfReturn": "20.54",
      "rebalancingCount": 2,
      "totalStocks": 171
    }
  }
}
```

### POST /api/backtest-etf

ETF持仓复制回测接口（单次持仓，双因子加权）

使用最新的持仓数据进行回测，不考虑历史持仓变化。

**请求体：**
```json
{
  "startDate": "20240101",
  "endDate": "20241204"
}
```

**响应：**
```json
{
  "success": true,
  "data": {
    "portfolio": [
      {"date": "20240101", "netValue": 1.0},
      {"date": "20240102", "netValue": 1.02}
    ],
    "etf": [
      {"date": "20240101", "netValue": 1.0},
      {"date": "20240102", "netValue": 1.01}
    ],
    "stocksInfo": [
      {
        "code": "601838.SH",
        "name": "成都银行",
        "industry": "银行",
        "marketCap": "523.45",
        "weight": "2.35",
        "dividendYield": "4.52",
        "roce": "12.38"
      }
    ],
    "statistics": {
      "portfolioReturn": "15.23",
      "etfReturn": "12.45",
      "stockCount": 84,
      "validStocks": 82
    }
  }
}
```

## 数据说明

### 持仓数据

- **数据源**：Tushare `fund_portfolio` 接口
- **更新频率**：季度更新（Q2和Q4为完整持仓，Q1和Q3可能只有前十大）
- **自动选择**：系统自动选择最新的Q2或Q4数据，确保获取完整持仓

### 财务数据

- **股息率**：来自 `daily_basic` 接口，使用最近交易日数据
- **EBIT**：来自 `income` 接口（利润表）
- **总资产/流动负债**：来自 `balancesheet` 接口（资产负债表）
- **报告期**：根据回测结束日期自动选择最近的财报期

### 缺失数据处理

**ROCE计算的回退机制**：
- **优先使用 `ebit`**（息税前利润）
- **如果EBIT为null，使用 `operate_profit`**（营业利润）- 适用于银行等金融企业
- **如果仍为null，使用 `total_profit`**（利润总额）
- **如果完全无法获取**：该股票ROCE显示为"-"，权重为0，不参与组合

**其他数据处理**：
- **股息率为0**：在权重计算时赋予最小值0.01%，避免完全排除
- **市值缺失**：在股票信息表中显示为"-"
- **只有同时具备股息率和ROCE的股票才参与双因子加权**

## 注意事项

1. **Tushare权限**：需要有效的 Tushare Pro Token，部分接口需要较高积分权限
   - `fund_portfolio`：需要5000积分
   - `balancesheet`、`income`、`fina_indicator`：需要2000积分
   - `daily`、`daily_basic`：基础权限即可

2. **API频率限制**：
   - 系统已实现批量处理和延迟机制
   - 每批10只股票处理历史数据
   - 每批8只股票处理财务数据
   - 批次间延迟500ms

3. **数据时效性**：
   - 财务数据通常滞后1-2个季度
   - 持仓数据每季度更新一次
   - 建议定期重新运行回测以获取最新数据

4. **回测局限性**：
   - 不考虑交易成本和税费
   - 不考虑流动性约束
   - 历史表现不代表未来收益
   - 仅供学习和研究使用

## 项目结构

```
xx-etf-js/
├── server.js           # Express服务器和API端点
├── public/
│   └── index.html      # 前端页面
├── .env                # 环境变量配置（需自行创建）
├── package.json        # 项目依赖
└── README.md           # 项目文档
```

## 开发计划

- [ ] 添加更多因子（如市盈率、市净率）
- [ ] 支持自定义因子权重
- [ ] 添加回测性能指标（夏普比率、最大回撤等）
- [ ] 支持多个ETF对比
- [ ] 导出回测报告功能

## 版本信息

### v1.2.0-tushare (当前版本)

**发布日期**: 2024-12-05

**主要特性**:
- ✅ 基于Tushare Pro API实时获取数据
- ✅ 双因子加权模型（股息率 + ROCE）
- ✅ 支持金融企业ROCE计算
- ✅ 智能数据处理和缺失值填充
- ✅ 可视化净值曲线对比
- ✅ 详细的股票信息展示

**技术栈**:
- Node.js + Express
- Tushare Pro API
- Chart.js 可视化
- 批量处理优化

**使用说明**:
1. 配置 `TUSHARE_TOKEN` 环境变量
2. 运行 `npm install` 安装依赖
3. 运行 `node server.js` 启动服务
4. 访问 `http://localhost:3001` 使用系统

**版本恢复**:
```bash
# 如需恢复到此版本
git checkout v1.2.0-tushare
```

## 许可证

MIT License

## 贡献

欢迎提交 Issue 和 Pull Request！

## 免责声明

本系统仅供学习和研究使用，不构成任何投资建议。投资有风险，入市需谨慎。
